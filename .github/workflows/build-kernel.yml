name: Build Kernel - Update KSU-Next

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3 python-is-python3 wget
    
    - name: Clone kernel source
      run: |
        git clone --depth=1 https://github.com/Motorola-Miami/android_kernel_motorola_sm6375 kernel
    
    - name: Download toolchain
      run: |
        git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 toolchain-gcc
        git clone --depth=1 https://github.com/kdrag0n/proton-clang toolchain-clang
    
    - name: Update KSU-Next
      run: |
        cd kernel
        curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s legacy
    
    - name: Download kernel config
      run: |
        cd kernel
        wget -O .config https://gist.githubusercontent.com/Sklen34/ba4d4b4399290aa03cc3dadc91720adc/raw/705ef6be4d48f3ce944d776bbd3cd675d68d32b7/Config
    
    - name: Build kernel
      run: |
        cd kernel
        export ARCH=arm64
        export SUBARCH=arm64
        export PATH=$(pwd)/../toolchain-clang/bin:$(pwd)/../toolchain-gcc/bin:$PATH
        export CROSS_COMPILE=aarch64-linux-android-
        export CROSS_COMPILE_ARM32=arm-linux-androideabi-
        export CC=clang
        make oldconfig
        make -j$(nproc)
    
    - name: Upload kernel image
      uses: actions/upload-artifact@v4
      with:
        name: kernel-ksu-updated
        path: kernel/arch/arm64/boot/Image.gz-dtb
